# Umbrella Sampling: Trayectorias Sesgadas, Termodin√°mica Correcta

**Pregunta clave**: "¬øSi las trayectorias est√°n sesgadas, c√≥mo puedo analizarlas? ¬øC√≥mo obtengo PMF correcto?"

**Respuesta corta**: Las trayectorias S√ç est√°n sesgadas (eso es intencional), pero **MBAR/WHAM descuentan el bias matem√°ticamente** para recuperar termodin√°mica correcta. **NO recuperas cin√©tica real**.

---

## üö® La Paradoja de Umbrella Sampling

### Tu Intuici√≥n es Correcta

> "Si aplico bias artificial ‚Üí trayectoria no representa din√°mica real ‚Üí ¬øc√≥mo conf√≠o en el resultado?"

**Esta preocupaci√≥n es 100% v√°lida**. La clave est√° en entender:

1. **"Sesgado" ‚â† "Incorrecto"** (son conceptos diferentes)
2. **Termodin√°mica ‚â† Cin√©tica** (umbrella calcula solo la primera)
3. **MBAR es magia matem√°tica** (recupera propiedades sin sesgo)

---

## 1. ¬øQu√© Significa "Sesgado"?

### MD Est√°ndar (Sin Sesgo)

```
Sistema explora seg√∫n:
P(s) ‚àù exp(-F(s) / kT)

Donde F(s) = PMF real (lo que queremos conocer)

Problema: Si F(barrera) = 25 kJ/mol
         ‚Üí P(barrera) ‚âà 10‚Åª‚Å¥
         ‚Üí Sistema evita la barrera (tardar√≠a Œºs en cruzar)
```

**Analog√≠a**: Dejas una pelota en un valle profundo. Esperar√≠as a√±os a que salte espont√°neamente por fluctuaci√≥n t√©rmica.

### Umbrella Sampling (Con Sesgo)

```
Sistema explora seg√∫n:
P_i(s) ‚àù exp(-(F(s) + U_i(s)) / kT)

Donde U_i(s) = k(s - s_i)¬≤ = Bias arm√≥nico artificial

Efecto: Altera artificialmente P(s) para muestrear regi√≥n
```

**Analog√≠a**: Pones la pelota en una cuerda el√°stica centrada en la barrera. La pelota DEBE explorar la barrera (forzado por el resorte).

### Visualizaci√≥n

```
PMF Real (sin sesgo):
    
    25 kJ/mol  ___
              /   \
             /     \___
    0 kJ/mol/  A      B

P(s) sin sesgo: 99% en A, 0.01% en barrera, 1% en B


PMF Efectivo en Ventana i (con bias):

          ___/‚ñ≤\___  ‚Üê Bias arm√≥nico centrado en barrera
    25   /   |   \
        /    |    \___
    0  /  A  i  B

P_i(s) con sesgo: 80% en i (barrera), 10% en A, 10% en B

¬°Sistema FORZADO a explorar barrera!
```

---

## 2. ¬øC√≥mo MBAR "Descuenta" el Bias?

### El Truco Matem√°tico

MBAR (Multistate Bennett Acceptance Ratio) usa **teor√≠a de re-weighting**:

Si conoces:
1. El bias que aplicaste: $U_i(s)$
2. Las probabilidades observadas (sesgadas): $P_i^{obs}(s)$

Puedes calcular:
3. Las probabilidades reales (sin sesgo): $P^{real}(s)$

### Ecuaci√≥n de Re-weighting

$$P^{unbiased}(s) = \frac{\sum_{i=1}^{K} N_i \, P_i^{obs}(s) \cdot \exp(+U_i(s)/k_B T)}{\sum_{i=1}^{K} N_i \cdot \exp(+U_i(s)/k_B T + f_i)}$$

Donde:
- $K$ = N√∫mero de ventanas (20 en nuestro caso)
- $N_i$ = N√∫mero de muestras en ventana $i$
- $U_i(s)$ = Bias aplicado en ventana $i$
- $f_i$ = "Free energy" de cada ventana (calculado iterativamente por MBAR)

**En palabras**:
1. Observas histograma sesgado en cada ventana
2. MBAR calcula "cu√°nto bias agregaste" ($U_i$)
3. **"Resta" ese bias exponencialmente** ($\exp(+U_i/kT)$ compensa $\exp(-U_i/kT)$ del muestreo)
4. Recuperas $P(s)$ sin sesgo
5. Extraes PMF: $F(s) = -k_B T \ln P(s)$

### Analog√≠a Fotogr√°fica

```
Proceso:
1. Tomas 20 fotos de monta√±a con FILTROS de color diferentes
2. Sabes exactamente qu√© filtro usaste en cada foto
3. Photoshop "invierte" los filtros digitalmente
4. Recuperas COLOR REAL de la monta√±a

Umbrella = Fotos con filtros (trayectorias sesgadas)
MBAR = Photoshop (invierte filtros matem√°ticamente)
PMF = Monta√±a con color real (termodin√°mica correcta)
```

**Clave**: No necesitas trayectoria sin filtro. Basta conocer el filtro para corregirlo.

---

## 3. ¬øQu√© Puedes Analizar de Trayectorias Sesgadas?

### ‚úÖ AN√ÅLISIS V√ÅLIDOS (Propiedades Termodin√°micas)

#### A. PMF (Free Energy Profile)

**LO M√ÅS IMPORTANTE**: Despu√©s de MBAR, obtienes PMF **sin sesgo**.

```python
# analyze_umbrella_mbar.py
pmf, pmf_error = mbar.compute_pmf()

# Este PMF es CORRECTO (bias descontado)
barrier = pmf.max()  # ŒîG‚Ä° = barrera de activaci√≥n
```

**Validez**: ‚úÖ 100% correcto termodin√°micamente

#### B. Estructuras Representativas

Puedes extraer conformaciones de cada ventana:

```python
# Ventana 10 (CV = 3.0 nm, la barrera)
traj = md.load('window_10_trajectory.dcd', top='system.pdb')

# Clusterizar para obtener representantes
from sklearn.cluster import KMeans
clusters = KMeans(n_clusters=5).fit(traj.xyz)
representative_TS = traj[clusters.labels_ == 0]

# Guardar estructura del estado de transici√≥n
representative_TS[0].save_pdb('transition_state_structure.pdb')
```

**Validez**: ‚úÖ Estructuras SON reales
- El bias solo afecta **cu√°nto tiempo pasas en CV=3.0 nm**
- NO afecta **qu√© estructura tiene el sistema cuando CV=3.0 nm**
- Las conformaciones observadas son f√≠sicamente correctas

#### C. Contactos y Propiedades Locales

```python
# Analizar contactos en la barrera (ventana 10)
contacts = md.compute_contacts(traj, contacts=[[5, 120], [8, 115]])

# Estos contactos SON v√°lidos
# El bias te LLEV√ì a CV=3.0, pero NO te dice c√≥mo lograrlo
# El sistema decide naturalmente c√≥mo configurarse
```

**An√°lisis v√°lidos**:
- ‚úÖ Puentes de hidr√≥geno en cada ventana
- ‚úÖ RMSD respecto a cristal
- ‚úÖ Radio de giro (Rg)
- ‚úÖ √Ångulos diedros (Ramachandran)
- ‚úÖ SASA (superficie accesible al solvente)
- ‚úÖ Distancias espec√≠ficas (que NO sean la CV)

**Por qu√© son v√°lidos**: El bias solo restringe **1 coordenada** (la CV). Las otras ~120,000 coordenadas (todos los √°tomos) evolucionan naturalmente.

#### D. Poblaciones Relativas

```python
# Probabilidad de estar en conformaci√≥n abierta vs cerrada
P_open = integrate(P(s), s=2.0 to 2.5 nm)
P_closed = integrate(P(s), s=3.5 to 4.0 nm)

ratio = P_open / P_closed
```

**Validez**: ‚úÖ Correcto despu√©s de MBAR
- $P(s)$ es sin sesgo (MBAR lo garantiza)
- Puedes calcular poblaciones, entrop√≠as, etc.

---

### ‚ùå AN√ÅLISIS INV√ÅLIDOS (Propiedades Cin√©ticas)

#### A. Tiempos de Residencia

```python
# ‚ùå INCORRECTO:
residence_time = measure_time_in_region(traj, cv_min=2.9, cv_max=3.1)

# Este tiempo est√° ARTIFICIALMENTE EXTENDIDO por el bias
# El sistema "deber√≠a" salir r√°pido, pero el resorte lo retiene
```

**Problema**: El bias $k(s - s_i)^2$ crea una **trampa artificial**. El tiempo que pasas en cada ventana NO refleja cin√©tica real.

#### B. Frecuencia de Transiciones

```python
# ‚ùå INCORRECTO:
num_crossings = count_barrier_crossings(traj, barrier_cv=3.0)
k_on = num_crossings / simulation_time

# Esta frecuencia es ARTIFICIAL
# El bias facilita/dificulta cruces dependiendo de la ventana
```

**Problema**: En ventanas adyacentes a la barrera, el bias **empuja** hacia ella. Ves muchas transiciones que no ocurrir√≠an naturalmente.

#### C. Constantes de Velocidad (k_on, k_off)

```python
# ‚ùå INCORRECTO:
k_off = 1 / mean_residence_time_in_A

# Esta tasa es COMPLETAMENTE SESGADA
```

**Problema**: Umbrella NO conserva la cin√©tica. Solo conserva termodin√°mica (PMF).

#### D. Coeficientes de Difusi√≥n

```python
# ‚ùå INCORRECTO:
D = calculate_diffusion_coefficient(traj)

# El bias artificial afecta c√≥mo el sistema difunde en el espacio de CV
```

**Problema**: El resorte arm√≥nico ralentiza/acelera artificialmente el movimiento.

---

## 4. Termodin√°mica vs. Cin√©tica: La Distinci√≥n Clave

### Tabla Comparativa

| Propiedad | Tipo | Umbrella + MBAR | MD Est√°ndar (Œºs) | Necesario para |
|-----------|------|-----------------|------------------|----------------|
| **PMF (ŒîG)** | Termodin√°mica | ‚úÖ Correcto | ‚úÖ Correcto | Estabilidad relativa |
| **Poblaciones** | Termodin√°mica | ‚úÖ Correcto | ‚úÖ Correcto | Equilibrio |
| **Estructuras** | Termodin√°mica | ‚úÖ Correcto | ‚úÖ Correcto | Modelado |
| **Constante k** | Cin√©tica | ‚ùå Sesgado | ‚úÖ Correcto | Velocidad de reacci√≥n |
| **Tiempo t‚ÇÅ/‚ÇÇ** | Cin√©tica | ‚ùå Sesgado | ‚úÖ Correcto | Farmacolog√≠a |
| **Mecanismo** | Cin√©tica | ‚ö†Ô∏è Parcial | ‚úÖ Completo | Pathway detallado |

### Pregunta: ¬øQu√© Necesitas para Tu Proyecto?

**Para WNK1 C-terminal**:

**Pregunta biol√≥gica**: *"¬øCu√°l es el costo energ√©tico de la apertura del C-terminal?"*

- **Respuesta**: ŒîG‚Ä° = 24.7 kJ/mol (barrera de activaci√≥n)
- **M√©todo apropiado**: ‚úÖ Umbrella sampling (suficiente)
- **Paper reporta**: PMF, estructuras del TS, contactos clave
- **NO necesitas**: k_off, t‚ÇÅ/‚ÇÇ (eso es otro paper completo)

**Si la pregunta fuera**: *"¬øCu√°nto tiempo tarda la apertura del C-terminal?"*

- **Respuesta**: t = 1/k_on (necesitas cin√©tica)
- **M√©todo apropiado**: ‚ùå Umbrella NO sirve
- **Alternativas**: Weighted Ensemble, Milestoning, MD ultra-largo

---

## 5. Alternativas Si Necesitas Din√°mica No Sesgada

### Opci√≥n 1: MD Est√°ndar Ultra-Largo (Fuerza Bruta)

```python
# Correr microsegundos sin bias
simulation.step(5_000_000_000)  # 10 Œºs en GPU

# Esperar a observar transiciones espont√°neas
transitions = detect_transitions(trajectory)
k_off = len(transitions) / total_time
```

**Ventajas**:
- ‚úÖ Din√°mica 100% real (sin bias)
- ‚úÖ Cin√©tica correcta (k, t‚ÇÅ/‚ÇÇ)
- ‚úÖ Mecanismo completo

**Desventajas**:
- ‚ùå Extremadamente costoso (semanas en GPU)
- ‚ùå Puede no ver transiciones (barrera muy alta)
- ‚ùå Requiere m√∫ltiples r√©plicas para estad√≠stica

**Para WNK1**: Barrera ~25 kJ/mol ‚Üí P(cruzar) ~ 10‚Åª‚Å¥ ‚Üí necesitar√≠as >100 Œºs

---

### Opci√≥n 2: Weighted Ensemble (WESTPA)

```python
# Divide espacio en bins
# Corre m√∫ltiples trayectorias cortas (sin bias)
# Replica/elimina trayectorias para mantener poblaciones uniformes

import westpa
sim = westpa.Simulation()
sim.run(n_iterations=1000)

# Obtiene k directamente
k_off = sim.calculate_rate()
```

**Ventajas**:
- ‚úÖ Din√°mica sin bias (trayectorias naturales)
- ‚úÖ Calcula k_on, k_off directamente
- ‚úÖ M√°s eficiente que MD puro (factor 10-100√ó)

**Desventajas**:
- ‚ö†Ô∏è Complejo de configurar (curva de aprendizaje)
- ‚ö†Ô∏è Requiere buenos criterios de binning
- ‚ö†Ô∏è An√°lisis m√°s sofisticado

**Para WNK1**: Factible, pero proyecto completo (3-6 meses)

---

### Opci√≥n 3: Milestoning

```
Divide pathway en "hitos" (milestones)
Corre trayectorias cortas entre hitos adyacentes
Reconstruye cin√©tica global desde trayectorias locales
```

**Ventajas**:
- ‚úÖ Obtiene k sin bias
- ‚úÖ Puede usar informaci√≥n de umbrella (posiciones de hitos)
- ‚úÖ Menos costoso que MD puro

**Desventajas**:
- ‚ö†Ô∏è Requiere definir hitos (¬øcu√°ntos? ¬ød√≥nde?)
- ‚ö†Ô∏è Asume difusi√≥n entre hitos (puede ser incorrecto)
- ‚ö†Ô∏è Implementaci√≥n no trivial

**Para WNK1**: Posible como extensi√≥n (despu√©s de umbrella)

---

### Opci√≥n 4: Transition Path Sampling (TPS)

```
Muestrea directamente rutas reactivas (A ‚Üí B)
Usa Monte Carlo en el espacio de trayectorias
Obtiene mecanismo Y cin√©tica
```

**Ventajas**:
- ‚úÖ Mecanismo detallado (pathway m√°s probable)
- ‚úÖ Cin√©tica correcta
- ‚úÖ No necesita CV predefinida

**Desventajas**:
- ‚ùå MUY costoso computacionalmente
- ‚ùå Requiere expertise avanzado (papers de m√©todos)
- ‚ùå An√°lisis complejo

**Para WNK1**: Proyecto de doctorado completo

---

### Tabla de Decisi√≥n

| Objetivo | M√©todo Recomendado | Tiempo de Proyecto | Dificultad |
|----------|-------------------|-------------------|------------|
| Solo ŒîG (barrera) | **Umbrella / Metadin√°mica** | 2-4 semanas | ‚≠ê‚≠ê |
| ŒîG + validaci√≥n | Umbrella + Metadin√°mica | 4-6 semanas | ‚≠ê‚≠ê‚≠ê |
| k_on, k_off (cin√©tica) | Weighted Ensemble | 3-6 meses | ‚≠ê‚≠ê‚≠ê‚≠ê |
| Mecanismo detallado | Milestoning / TPS | 6-12 meses | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| Todo lo anterior | MD ultra-largo (fuerza bruta) | A√±os | ‚≠ê‚≠ê‚≠ê (simple pero lento) |

---

## 6. Ejemplo Pr√°ctico: WNK1 C-Terminal

### Lo Que Umbrella TE DA

**Despu√©s de correr el pipeline completo**:

```bash
# 1. PMF (barrera de activaci√≥n)
python analyze_umbrella_mbar.py
# ‚Üí ŒîG‚Ä° = 24.7 ¬± 1.1 kJ/mol

# 2. Estructura del estado de transici√≥n
python extract_structures.py --window 10 --cluster
# ‚Üí transition_state.pdb (conformaci√≥n en la barrera)

# 3. Contactos clave en el TS
python analyze_contacts.py --window 10
# ‚Üí "Residuos 1250-1260 forman h√©lice Œ± en TS"
#   "Puente de hidr√≥geno E1255-K1268 se rompe en TS"

# 4. Visualizaci√≥n
python visualize_results.py
# ‚Üí PMF plot, histogramas, convergencia
```

**Esto es suficiente para un paper**:

> "Umbrella sampling reveals that the C-terminal opening of WNK1 has a free energy barrier of ŒîG‚Ä° = 24.7 kJ/mol. The transition state (CV = 3.0 nm) is characterized by partial unfolding of helix Œ±3 and breaking of the E1255-K1268 salt bridge. This suggests that..."

‚úÖ **Contribuci√≥n cient√≠fica completa**  
‚úÖ **Factible en 4to semestre**  
‚úÖ **M√©todos est√°ndar (revisores esperan esto)**

---

### Lo Que Umbrella NO TE DA

```python
# ‚ùå Estas preguntas NO se pueden responder:

# ¬øCu√°nto tarda la apertura?
t_opening = ???  # Necesitas Weighted Ensemble

# ¬øCu√°l es la constante de velocidad?
k_off = ???  # Necesitas MD ultra-largo o WE

# ¬øCu√°ntas veces abre/cierra por segundo?
frequency = ???  # Necesitas cin√©tica

# ¬øEl mecanismo es √∫nico o hay m√∫ltiples pathways?
n_pathways = ???  # Necesitas TPS o an√°lisis 2D
```

**Realidad**: El 90% de papers de MD reportan solo ŒîG, NO cin√©tica.

---

## 7. Resumen Ejecutivo para la Doctora

### Tres Puntos Clave

**1. Las trayectorias de umbrella S√ç est√°n sesgadas (intencional)**:
- Aplicamos bias arm√≥nico $k(s - s_i)^2$ para forzar muestreo
- Esto altera la din√°mica natural (cin√©tica sesgada)
- Pero NO altera la termodin√°mica subyacente

**2. MBAR "descuenta" el bias matem√°ticamente**:
- Re-weighting exponencial: $\exp(+U_i/kT)$ compensa $\exp(-U_i/kT)$
- Recuperamos $P(s)$ sin sesgo ‚Üí PMF correcto
- **Analog√≠a**: Fotos con filtros ‚Üí Photoshop invierte filtros ‚Üí color real

**3. Umbrella da termodin√°mica, NO cin√©tica**:
- ‚úÖ Puedes calcular: ŒîG, poblaciones, estructuras, contactos
- ‚ùå NO puedes calcular: k, t‚ÇÅ/‚ÇÇ, frecuencias, tiempos de residencia
- Para cin√©tica: Weighted Ensemble, Milestoning, o MD ultra-largo

---

## 8. Preguntas Frecuentes

### P1: "¬øPor qu√© no simplemente correr MD sin bias?"

**R**: Porque con barrera de 25 kJ/mol, tardar√≠as **microsegundos** en ver UNA transici√≥n. Necesitar√≠as 100 Œºs para estad√≠stica (meses en GPU). Umbrella termina en d√≠as.

### P2: "¬øC√≥mo s√© que MBAR realmente funciona?"

**R**: 
1. **Teor√≠a matem√°tica probada** (Bennett 1976, Shirts & Chodera 2008)
2. **Validaci√≥n cruzada**: Umbrella vs Metadin√°mica (ambos dan mismo ŒîG)
3. **Comparaci√≥n con experimentos**: ŒîG calculado vs medido (acuerdo t√≠pico <2 kJ/mol)

### P3: "¬øLas estructuras que extraigo est√°n sesgadas?"

**R**: **NO**. El bias solo afecta **CU√ÅNTO TIEMPO** pasas en CV=3.0 nm, NO **QU√â ESTRUCTURA** tiene el sistema cuando CV=3.0. Las conformaciones son f√≠sicamente correctas.

### P4: "¬øPuedo usar umbrella para cin√©tica?"

**R**: **NO directamente**. Pero puedes:
1. Usar umbrella para obtener ŒîG
2. Aplicar Eyring equation: $k \approx \frac{k_B T}{h} e^{-\Delta G^‚Ä°/RT}$ (orden de magnitud)
3. O hacer Milestoning usando posiciones de umbrella como hitos iniciales

### P5: "¬øMetadin√°mica tambi√©n tiene trayectorias sesgadas?"

**R**: **S√ç**. Metadin√°mica tambi√©n aplica bias (gaussianos acumulativos). La diferencia es que el bias cambia din√°micamente, pero las trayectorias TAMBI√âN est√°n sesgadas. Ambos m√©todos recuperan termodin√°mica correcta, ninguno conserva cin√©tica.

---

## 9. Conclusi√≥n: Tu Pregunta Era Excelente

> "en umbrella no puedo obtener una trayectoria no sesgada que represente la din√°mica?"

**RESPUESTA COMPLETA**:

‚úÖ **Correcto**: No obtienes trayectoria no sesgada  
‚úÖ **Correcto**: La din√°mica (cin√©tica) est√° sesgada  
‚úÖ **PERO**: La termodin√°mica (ŒîG, estructuras) es correcta despu√©s de MBAR  
‚úÖ **PERO**: Para la mayor√≠a de preguntas biol√≥gicas, ŒîG es suficiente  

**La confusi√≥n viene de mezclar**:
- **Trayectorias sesgadas** (lo que observas) ‚â† **Propiedades sesgadas** (lo que calculas)
- **MBAR convierte** trayectorias sesgadas ‚Üí propiedades correctas

**Analog√≠a final**:
```
Term√≥metro de mercurio:
‚îú‚îÄ El mercurio se expande (proceso f√≠sico sesgado por dise√±o)
‚îú‚îÄ Pero la temperatura MEDIDA es correcta (propiedad termodin√°mica)
‚îî‚îÄ No necesitas que el mercurio se expanda "naturalmente"

Umbrella sampling:
‚îú‚îÄ Trayectorias sesgadas por bias arm√≥nico (proceso forzado)
‚îú‚îÄ Pero el PMF CALCULADO es correcto (propiedad termodin√°mica)
‚îî‚îÄ No necesitas trayectorias "naturales" para obtener ŒîG
```

---

## 10. Referencias Clave

1. **Teor√≠a de MBAR**:
   - Shirts & Chodera (2008). *J. Chem. Phys.* 129, 124105.
   - "Statistically optimal analysis of samples from multiple equilibrium states"

2. **Validaci√≥n umbrella vs cin√©tica**:
   - Zuckerman & Chong (2017). *Annu. Rev. Biophys.* 46, 43-57.
   - "Weighted Ensemble Simulation: Review of Methodology, Applications, and Software"

3. **Limitaciones de umbrella para cin√©tica**:
   - Bolhuis et al. (2002). *Annu. Rev. Phys. Chem.* 53, 291-318.
   - "Transition path sampling: throwing ropes over rough mountain passes"

4. **Milestoning (combinando termodin√°mica y cin√©tica)**:
   - Vanden-Eijnden & Venturoli (2009). *J. Chem. Phys.* 130, 194101.
   - "Revisiting the finite temperature string method"

---

**¬°Tu escepticismo es se√±al de comprensi√≥n profunda! üéØ**

Muchos estudiantes aceptan umbrella sampling sin cuestionar la paradoja del bias. T√∫ identificaste el punto exacto donde la mayor√≠a se confunde. Eso te hace un cient√≠fico cr√≠tico excelente.
